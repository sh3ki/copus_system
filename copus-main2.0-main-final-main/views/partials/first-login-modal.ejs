<!-- First-Time Login Password Change Modal -->
<!-- This modal appears on top of all dashboards when isFirstLogin is true -->
<!-- DEBUG: user = <%= typeof user !== 'undefined' ? JSON.stringify(user) : 'undefined' %> -->
<% if (typeof user !== 'undefined' && user && user.isFirstLogin === true) { %>
<div class="modal fade" id="firstLoginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="firstLoginModalLabel" aria-hidden="true" style="z-index: 99999;">
  <div class="modal-dialog modal-dialog-centered" style="z-index: 100000; position: relative;">
    <div class="modal-content" style="background: linear-gradient(135deg, #1a2a3a, #2c3e50); border: 2px solid #17e891; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); position: relative; z-index: 100001;">
      
      <!-- Modal Header -->
      <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1); background: rgba(23, 232, 145, 0.1);">
        <h5 class="modal-title" id="firstLoginModalLabel" style="color: #17e891; font-weight: 600;">
          <i class="bi bi-shield-lock-fill me-2"></i>Change Your Password
        </h5>
        <!-- Cannot close this modal -->
      </div>

      <!-- Modal Body -->
      <div class="modal-body" style="color: #e0e0e0;">
        <!-- Warning Alert -->
        <div class="alert" style="background-color: #fff3cd; border-left: 4px solid #ffc107; color: #856404; margin-bottom: 1.5rem; border-radius: 8px;">
          <div style="display: flex; align-items: center;">
            <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 1.5rem;"></i>
            <div>
              <strong>Security Required</strong>
              <p class="mb-0" style="font-size: 0.9rem; margin-top: 0.25rem;">
                This is your first-time login. You must change your temporary password to continue.
              </p>
            </div>
          </div>
        </div>

        <!-- Password Change Form -->
        <form id="firstLoginPasswordForm" action="/change_password" method="POST">
          <div class="mb-3">
            <label for="newPassword" class="form-label" style="color: #17e891; font-weight: 500;">
              <i class="bi bi-key-fill me-2"></i>New Password
            </label>
            <input 
              type="password" 
              class="form-control" 
              id="newPassword" 
              name="newPassword" 
              required 
              minlength="6"
              style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; padding: 0.75rem;"
              placeholder="Enter a strong password (min. 6 characters)"
            >
            <div class="form-text" style="color: #b0b0b0; font-size: 0.85rem;">
              <i class="bi bi-info-circle me-1"></i>
              Choose a strong password with at least 6 characters
            </div>
          </div>

          <div class="mb-3">
            <label for="confirmPassword" class="form-label" style="color: #17e891; font-weight: 500;">
              <i class="bi bi-shield-check me-2"></i>Confirm New Password
            </label>
            <input 
              type="password" 
              class="form-control" 
              id="confirmPassword" 
              name="confirmPassword" 
              required 
              minlength="6"
              style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; padding: 0.75rem;"
              placeholder="Re-enter your new password"
            >
            <div id="passwordMatchError" class="text-danger mt-1" style="display: none; font-size: 0.85rem;">
              <i class="bi bi-x-circle-fill me-1"></i>Passwords do not match!
            </div>
          </div>

          <!-- Password Strength Indicator -->
          <div class="mb-3">
            <div class="password-strength-bar" style="height: 4px; background-color: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
              <div id="strengthBar" style="height: 100%; width: 0%; background-color: #17e891; transition: width 0.3s ease;"></div>
            </div>
            <div id="strengthText" class="form-text" style="color: #b0b0b0; font-size: 0.85rem; margin-top: 0.5rem;">
              Password strength: <span id="strengthLabel">N/A</span>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="d-grid">
            <button 
              type="submit" 
              class="btn btn-lg" 
              id="submitPasswordBtn"
              style="background: linear-gradient(135deg, #17e891, #14c97a); color: #0f2027; font-weight: 600; border: none; padding: 0.85rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(23, 232, 145, 0.3); transition: all 0.3s ease;"
              onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(23, 232, 145, 0.5)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(23, 232, 145, 0.3)';"
            >
              <i class="bi bi-check-circle-fill me-2"></i>Change Password
            </button>
          </div>
        </form>

        <!-- Info Box -->
        <div class="mt-3" style="background-color: rgba(23, 232, 145, 0.1); border-left: 4px solid #17e891; padding: 1rem; border-radius: 8px;">
          <p class="mb-0" style="font-size: 0.9rem; color: #b0b0b0;">
            <i class="bi bi-lightbulb-fill me-2" style="color: #17e891;"></i>
            <strong style="color: #17e891;">Tip:</strong> Use a combination of letters, numbers, and symbols for a stronger password.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for First-Login Modal -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DO NOT auto-show this modal on page load - the activation modal will handle showing this
    // This modal will be shown programmatically after the activation modal is closed
    const firstLoginModal = document.getElementById('firstLoginModal');
    if (firstLoginModal) {
        // Wait for modal to be shown, then fix z-index AND pointer events
        firstLoginModal.addEventListener('shown.bs.modal', function () {
            // CRITICAL FIX: Make backdrop non-interactive but visible
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.style.zIndex = '99998';
                backdrop.style.pointerEvents = 'none'; // Allow clicks to pass through
            }
            
            // Set modal z-index ABOVE backdrop
            firstLoginModal.style.zIndex = '99999';
            firstLoginModal.style.pointerEvents = 'auto'; // Ensure modal can receive clicks
            
            // Set modal-dialog z-index even HIGHER with pointer events enabled
            const modalDialog = firstLoginModal.querySelector('.modal-dialog');
            if (modalDialog) {
                modalDialog.style.zIndex = '100000';
                modalDialog.style.position = 'relative';
                modalDialog.style.pointerEvents = 'auto'; // Ensure dialog can receive clicks
            }
            
            // Ensure modal-content is fully interactive
            const modalContent = firstLoginModal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.style.pointerEvents = 'auto';
                modalContent.style.position = 'relative';
                modalContent.style.zIndex = '100001';
            }
        });
    }

    // Password strength checker
    const newPasswordInput = document.getElementById('newPassword');
    const strengthBar = document.getElementById('strengthBar');
    const strengthLabel = document.getElementById('strengthLabel');

    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;

            if (password.length >= 6) strength += 25;
            if (password.length >= 10) strength += 25;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password)) strength += 12.5;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 12.5;

            strengthBar.style.width = strength + '%';

            if (strength < 40) {
                strengthBar.style.backgroundColor = '#e74c3c';
                strengthLabel.textContent = 'Weak';
                strengthLabel.style.color = '#e74c3c';
            } else if (strength < 70) {
                strengthBar.style.backgroundColor = '#f39c12';
                strengthLabel.textContent = 'Moderate';
                strengthLabel.style.color = '#f39c12';
            } else {
                strengthBar.style.backgroundColor = '#17e891';
                strengthLabel.textContent = 'Strong';
                strengthLabel.style.color = '#17e891';
            }
        });
    }

    // Password match validation
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const passwordMatchError = document.getElementById('passwordMatchError');
    const submitBtn = document.getElementById('submitPasswordBtn');

    function validatePasswordMatch() {
        if (confirmPasswordInput.value === '') {
            passwordMatchError.style.display = 'none';
            return true;
        }

        if (newPasswordInput.value !== confirmPasswordInput.value) {
            passwordMatchError.style.display = 'block';
            submitBtn.disabled = true;
            return false;
        } else {
            passwordMatchError.style.display = 'none';
            submitBtn.disabled = false;
            return true;
        }
    }

    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', validatePasswordMatch);
        newPasswordInput.addEventListener('input', validatePasswordMatch);
    }

    // Form submission validation
    const form = document.getElementById('firstLoginPasswordForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (newPasswordInput.value !== confirmPasswordInput.value) {
                e.preventDefault();
                passwordMatchError.style.display = 'block';
                confirmPasswordInput.focus();
                return false;
            }

            if (newPasswordInput.value.length < 6) {
                e.preventDefault();
                alert('Password must be at least 6 characters long.');
                newPasswordInput.focus();
                return false;
            }

            // Show loading state
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Changing Password...';
            submitBtn.disabled = true;

            return true;
        });
    }
});
</script>
<% } %>
